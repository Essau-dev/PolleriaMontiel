{% extends "layouts/base.html" %}
{% from "shared/_form_field.html" import render_field %} {# Importar macro #}

{% block title %}{{ title }} - SGPM{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10"> {# Usar clases de grid para centrar y limitar ancho #}
        {# Añadir data attribute para pasar el ID de la dirección de entrega actual a JS #}
        <div class="card" data-pedido-direccion-id="{{ pedido.direccion_entrega_id | tojson }}">
            <div class="card__header">
                <h1 class="card__title mb-0">{{ title }}</h1>
                <p class="card__subtitle">Creado por: {{ pedido.usuario_creador.nombre_completo }} el {{ format_datetime(pedido.fecha_creacion) }}</p>
            </div>
            <div class="card__body">
                {# Mostrar mensajes de error si el formulario principal falla #}
                {% if form.errors %}
                    <div class="alert alert--danger">
                        <p>Por favor, corrige los siguientes errores:</p>
                        <ul>
                            {% for field, errors in form.errors.items() %}
                                <li>{{ field.label.text }}: {{ ', '.join(errors) }}</li> {# Mostrar label del campo #}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <form id="pedido-edit-form" method="POST" action="{{ url_for('pedidos.editar_pedido', pedido_id=pedido.id) }}">
                    {{ form.hidden_tag() }} {# CSRF token #}

                    {# Mostrar ID del pedido (no editable) #}
                    <div class="form-group">
                        <label class="form-label">Folio Pedido</label>
                        <input type="text" class="form-control" value="{{ format_pedido_folio(pedido.id) }}" readonly> {# Usar helper #}
                    </div>

                    {# Sección de Datos del Cliente #}
                    <h2 class="card__subtitle mt-m">Datos del Cliente</h2>
                    <div class="row"> {# Usar grid para layout #}
                        <div class="col-md-6">
                            {# Campo de búsqueda de cliente (requiere JS/AJAX) #}
                            <div class="form-group">
                                <label class="form-label" for="cliente_search">Buscar Cliente (Nombre, Teléfono, Alias)</label>
                                {# Precargar con el nombre del cliente actual #}
                                <input type="text" id="cliente_search" class="form-control" placeholder="Escribe para buscar..." value="{{ pedido.cliente.get_nombre_completo() if pedido.cliente else '' }}">
                                {# Campo oculto para almacenar el ID del cliente seleccionado #}
                                {{ form.cliente_id(class="form-control", type="hidden", value=pedido.cliente_id) }}
                                {# Área para mostrar resultados de búsqueda y cliente seleccionado #}
                                <div id="cliente_search_results" class="search-results-dropdown"></div> {# Definir estilos en CSS #}
                                <div id="cliente_selected_info" class="mt-s">
                                    {% if pedido.cliente %}
                                        <strong>Cliente Seleccionado:</strong> {{ pedido.cliente.get_nombre_completo() }} ({{ pedido.cliente.tipo_cliente.name.replace('_', ' ').title() }})
                                    {% endif %}
                                </div> {# Mostrar info del cliente seleccionado #}
                            </div>
                        </div>
                        <div class="col-md-6">
                            {# Selector de dirección de entrega (dinámico, requiere JS/AJAX si el cliente tiene varias) #}
                            {# Para MVP simple, si se selecciona cliente, mostrar sus direcciones principales o un selector #}
                            <div class="form-group">
                                <label class="form-label" for="direccion_entrega_id">Dirección de Entrega (si aplica)</label>
                                {{ form.direccion_entrega_id(class="form-control") }} {# Este SelectField se poblará con JS #}
                                {# Opcional: Botón para añadir nueva dirección si el cliente está seleccionado #}
                                {# <button type="button" class="btn btn--secondary btn--sm mt-s" id="add_direccion_btn">Añadir Nueva Dirección</button> #}
                            </div>
                        </div>
                    </div>
                    {# Opcional: Campos para alta rápida de cliente si no se encuentra (inicialmente ocultos) #}
                    {#
                    <div id="new_client_fields" style="display: none;">
                        <h3 class="card__subtitle mt-m">Registrar Nuevo Cliente</h3>
                        {{ render_field(form.new_cliente_nombre, class="form-control") }}
                        {{ render_field(form.new_cliente_apellidos, class="form-control") }}
                        {{ render_field(form.new_cliente_alias, class="form-control") }}
                        {{ render_field(form.new_cliente_telefono, class="form-control") }}
                        {{ render_field(form.new_cliente_direccion, class="form-control") }}
                        {# ... otros campos de cliente/direccion si se añaden al form ... #}
                    </div>
                    #}

                    {# Sección de Carrito de Compras #}
                    <h2 class="card__subtitle mt-l">Productos del Pedido</h2>

                    {# Lista de ítems y PAs en el carrito (precargada con datos del pedido) #}
                    <div id="cart-items-list" class="mb-l"> {# Definir estilos en CSS #}
                        <h3 class="card__subtitle">Resumen del Pedido</h3>
                        {% if pedido.items.count() > 0 or pedido.productos_adicionales_pedido.count() > 0 %}
                            <ul id="items-list" class="list-group">
                                {% for item in pedido.items %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center" data-item-id="{{ item.id }}"> {# Añadir data-id para JS #}
                                        {{ item.cantidad|string.rstrip('0').rstrip('.') }} {{ item.unidad_medida }} {{ item.descripcion_item_venta }} {# Formatear cantidad #}
                                        {% if item.notas_item %}<br><em>Notas: {{ item.notas_item }}</em>{% endif %}
                                        <div class="ml-auto"> {# Usar clase de utilidad #}
                                            <span class="mr-s">{{ format_currency(item.subtotal_item) }}</span> {# Usar clase de espaciado #}
                                            {# Botones de acción para cada ítem (requiere JS/AJAX) #}
                                            <button type="button" class="btn btn--secondary btn--sm edit-item-btn" data-item-id="{{ item.id }}">Editar</button>
                                            <button type="button" class="btn btn--danger btn--sm delete-item-btn" data-item-id="{{ item.id }}">Eliminar</button>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                            <ul id="pas-list" class="list-group mt-s"> {# Usar clase de espaciado #}
                                {% for pa in pedido.productos_adicionales_pedido %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center" data-pa-id="{{ pa.id }}"> {# Añadir data-id para JS #}
                                        {{ pa.cantidad_pa|string.rstrip('0').rstrip('.') }} {{ pa.unidad_medida_pa }} {{ pa.nombre_pa }} (PA) {# Formatear cantidad #}
                                        {% if pa.notas_pa %}<br><em>Notas: {{ pa.notas_pa }}</em>{% endif %}
                                        <div class="ml-auto"> {# Usar clase de utilidad #}
                                            <span class="mr-s">{{ format_currency(pa.subtotal_pa) }}</span> {# Usar clase de espaciado #}
                                            {# Botones de acción para cada PA (requiere JS/AJAX) #}
                                            <button type="button" class="btn btn--secondary btn--sm edit-pa-btn" data-pa-id="{{ pa.id }}">Editar</button>
                                            <button type="button" class="btn btn--danger btn--sm delete-pa-btn" data-pa-id="{{ pa.id }}">Eliminar</button>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p id="empty-cart-message">Este pedido no tiene productos registrados.</p>
                        {% endif %}
                    </div>

                    {# Área para añadir Nuevos Productos de Pollo (requiere JS/AJAX) #}
                    <div class="add-item-section mb-m"> {# Definir estilos en CSS #}
                        <h3 class="card__subtitle">Añadir Nuevo Producto de Pollo</h3>
                        {# Formulario para añadir un item (puede ser un modal o sección) #}
                        {# Este formulario se manejará con JS y AJAX #}
                        <div id="add-item-form-area">
                            {# Aquí se renderizaría un formulario como PedidoItemForm #}
                            {# Usar el item_form pasado desde la ruta #}
                            <form id="new-item-form"> {# Formulario separado para AJAX #}
                                {{ item_form.hidden_tag() }} {# CSRF token para este form #}
                                <input type="hidden" name="pedido_id" value="{{ pedido.id }}"> {# Pasar ID del pedido #}
                                <div class="row g-s"> {# Usar grid con gap pequeño #}
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label" for="producto_search">Producto/Subproducto</label>
                                            <input type="text" id="producto_search" class="form-control" placeholder="Buscar producto...">
                                            {{ item_form.producto_id(class="form-control", type="hidden") }}
                                            {{ item_form.subproducto_id(class="form-control", type="hidden") }}
                                            <div id="producto_search_results" class="search-results-dropdown"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label" for="modificacion_id">Modificación</label>
                                            {{ item_form.modificacion_id(class="form-control") }} {# Este SelectField se poblará con JS/AJAX #}
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                         {{ render_field(item_form.cantidad, class="form-control") }}
                                    </div>
                                    <div class="col-md-2">
                                         {{ render_field(item_form.unidad_medida, class="form-control") }}
                                    </div>
                                    <div class="col-md-12">
                                         {{ render_field(item_form.notas_item, class="form-control") }}
                                    </div>
                                    {# Campo de precio unitario si se permite editar manualmente #}
                                    {# <div class="col-md-4">{{ render_field(item_form.precio_unitario_venta, class="form-control") }}</div> #}
                                    <div class="col-md-12 text-right">
                                        <button type="button" class="btn btn--secondary" id="add-item-btn">Añadir al Pedido</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    {# Área para añadir Nuevos Productos Adicionales (requiere JS/AJAX) #}
                    <div class="add-pa-section mb-m"> {# Definir estilos en CSS #}
                         <h3 class="card__subtitle">Añadir Nuevo Producto Adicional (PA)</h3>
                         {# Formulario para añadir un PA (puede ser un modal o sección) #}
                         {# Usar el pa_form pasado desde la ruta #}
                         <div id="add-pa-form-area">
                             <form id="new-pa-form"> {# Formulario separado para AJAX #}
                                 {{ pa_form.hidden_tag() }} {# CSRF token para este form #}
                                 <input type="hidden" name="pedido_id" value="{{ pedido.id }}"> {# Pasar ID del pedido #}
                                 <div class="row g-s">
                                     <div class="col-md-6">
                                         {{ render_field(pa_form.nombre_pa, class="form-control") }}
                                     </div>
                                     <div class="col-md-2">
                                         {{ render_field(pa_form.cantidad_pa, class="form-control") }}
                                     </div>
                                     <div class="col-md-2">
                                         {{ render_field(pa_form.unidad_medida_pa, class="form-control") }}
                                     </div>
                                     <div class="col-md-2">
                                         {{ render_field(pa_form.precio_venta_unitario_pa, class="form-control") }}
                                         {# Campo de costo_compra_unitario_pa si el Cajero lo registra #}
                                         {# {{ render_field(pa_form.costo_compra_unitario_pa, class="form-control") }} #}
                                     </div>
                                     <div class="col-md-12">
                                         {{ render_field(pa_form.notas_pa, class="form-control") }}
                                     </div>
                                     <div class="col-md-12 text-right">
                                         <button type="button" class="btn btn--secondary" id="add-pa-btn">Añadir PA al Pedido</button>
                                     </div>
                                 </div>
                             </form>
                         </div>
                    </div>


                    {# Sección de Resumen y Pago (se actualizará con JS/AJAX) #}
                    <div id="order-summary" class="mb-l"> {# Definir estilos en CSS #}
                        <h2 class="card__subtitle">Resumen y Pago</h2>
                        <p>Subtotal Productos Pollo: <strong id="subtotal_pollo_display">{{ format_currency(pedido.subtotal_productos_pollo) }}</strong></p>
                        <p>Subtotal Productos Adicionales: <strong id="subtotal_pas_display">{{ format_currency(pedido.subtotal_productos_adicionales) }}</strong></p>
                        {# Campos opcionales para descuento y costo de envío #}
                        {{ render_field(form.descuento_aplicado, class="form-control") }}
                        {{ render_field(form.costo_envio, class="form-control") }}
                        <p class="total-pedido">Total Pedido: <strong id="total_pedido_display">{{ format_currency(pedido.total_pedido) }}</strong></p> {# Definir estilos para .total-pedido #}

                        {# Sección de Pago #}
                        <div class="payment-section mt-m"> {# Definir estilos en CSS #}
                            {{ render_field(form.forma_pago, class="form-control") }}

                            {# Campos para pago en efectivo (inicialmente ocultos, se muestran con JS) #}
                            <div id="efectivo-fields" style="display: none;">
                                {{ render_field(form.paga_con, class="form-control") }}
                                <div id="cambio-info" class="mt-s"> {# Mostrar cambio y sugerencia de denominaciones #}
                                    <p>Cambio a entregar: <strong id="cambio_entregado_display">{{ format_currency(pedido.cambio_entregado) if pedido.cambio_entregado is not none else 0 }}</strong></p>
                                    {# Opcional: Sugerencia de denominaciones (requiere JS avanzado y datos de caja) #}
                                    {# <p>Sugerencia de cambio: <span id="denominaciones_sugeridas_display"></span></p> #}
                                </div>
                            </div>
                            {# Otros campos de pago si se necesitan (ej. referencia de transferencia) #}
                        </div>
                    </div>

                    {# Campos adicionales del pedido #}
                    {{ render_field(form.repartidor_id, class="form-control") }} {# Selector de repartidor #}
                    {{ render_field(form.fecha_entrega_programada, class="form-control") }}
                    {{ render_field(form.notas_pedido, class="form-control") }}
                    <div class="form-group form-check mb-m">
                        {{ form.requiere_factura(class="form-check-input") }}
                        {{ form.requiere_factura.label(class="form-check-label") }}
                    </div>

                    {# Botones de Acción #}
                    <div class="form-group">
                        {# El botón de submit principal del formulario #}
                        <button type="submit" class="btn btn--primary btn-block">{{ form.submit.label.text }}</button>
                        {# Botones adicionales que podrían estar aquí o en otro lugar, manejados por JS/AJAX #}
                        {# <button type="button" class="btn btn--success btn-block mt-s" id="finalizar-venta-btn">Finalizar Venta</button> #}
                        {# <button type="button" class="btn btn--info btn-block mt-s" id="enviar-cocina-btn">Enviar a Cocina</button> #}
                         {# Botón para procesar pago (si no se hace al guardar) #}
                         {% if pedido.estado_pedido not in [EstadoPedido.PAGADO, EstadoPedido.ENTREGADO_Y_PAGADO, EstadoPedido.CANCELADO_POR_CLIENTE, EstadoPedido.CANCELADO_POR_NEGOCIO] %}
                             <button type="button" class="btn btn--success btn-block mt-s" id="process-payment-btn">Procesar Pago</button> {# Requiere modal/JS #}
                         {% endif %}
                    </div>
                </form>
            </div>
            <div class="card__footer text-center">
                 <a href="{{ url_for('pedidos.ver_pedido', pedido_id=pedido.id) }}" class="btn btn--secondary btn--sm">Cancelar</a>
            </div>
        </div>
    </div>
</div>

{# Modales para editar ítem/PA (Opcional, requiere JS) #}
{#
<div id="edit-item-modal" class="modal">...</div>
<div id="edit-pa-modal" class="modal">...</div>
#}

{% block body_scripts %}
    {{ super() }} {# Mantener scripts de base.html #}
    <script>
        // Script específico para la página de editar pedido
        // Similar a crear_pedido.html pero con datos precargados
        // Manejar búsqueda de cliente con AJAX
        // Manejar adición/edición/eliminación de ítems/PAs con AJAX
        // Actualizar resumen del carrito y totales dinámicamente
        // Mostrar/ocultar campos de pago según la forma de pago seleccionada
        // Calcular cambio dinámicamente si la forma de pago es efectivo
        // Manejar botones de editar/eliminar ítems/PAs

        // Asumimos que formatCurrencyJS es una función helper JS global o definida en main.js
        // Si no, necesitamos una implementación simple aquí:
        function formatCurrencyJS(value) {
            if (value === null || isNaN(value)) return "$0.00";
            // Asegurarse de que el valor es un número antes de formatear
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return "$0.00";
            return "$" + numValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }


        document.addEventListener('DOMContentLoaded', function() {
            const clienteSearchInput = document.getElementById('cliente_search');
            const clienteSearchResults = document.getElementById('cliente_search_results');
            const clienteIdInput = document.getElementById('cliente_id');
            const clienteSelectedInfo = document.getElementById('cliente_selected_info');
            const direccionEntregaSelect = document.getElementById('direccion_entrega_id');
            const formaPagoSelect = document.getElementById('forma_pago');
            const efectivoFields = document.getElementById('efectivo-fields');
            const pagaConInput = document.getElementById('paga_con');
            const cambioEntregadoDisplay = document.getElementById('cambio_entregado_display');
            const totalPedidoDisplay = document.getElementById('total_pedido_display'); // Asumimos que este ID existe en el resumen

            // --- Lógica de Búsqueda de Cliente (AJAX) ---
             if (clienteSearchInput && clienteSearchResults && clienteIdInput) {
                let searchTimeout;
                clienteSearchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value;
                    if (query.length < 3) { // Mínimo 3 caracteres para buscar
                        clienteSearchResults.style.display = 'none';
                        return;
                    }
                    searchTimeout = setTimeout(function() {
                        fetch("{{ url_for('clientes.buscar_cliente_ajax') }}?q=" + encodeURIComponent(query)) // Usar url_for
                            .then(response => response.json())
                            .then(data => {
                                clienteSearchResults.innerHTML = ''; // Limpiar resultados anteriores
                                if (data.clientes && data.clientes.length > 0) {
                                    data.clientes.forEach(cliente => {
                                        const div = document.createElement('div');
                                        div.classList.add('search-result-item'); // Definir estilo en CSS
                                        div.textContent = `${cliente.nombre_completo} (${cliente.alias || 'Sin Alias'}) - ${cliente.telefono_principal || 'Sin Teléfono'}`;
                                        div.dataset.clienteId = cliente.id;
                                        div.dataset.clienteNombre = cliente.nombre_completo;
                                        div.dataset.clienteAlias = cliente.alias;
                                        div.dataset.clienteTipo = cliente.tipo_cliente;
                                        div.addEventListener('click', function() {
                                            const selectedId = this.dataset.clienteId;
                                            const selectedNombre = this.dataset.clienteNombre;
                                            const selectedAlias = this.dataset.clienteAlias;
                                            const selectedTipo = this.dataset.clienteTipo;

                                            clienteSearchInput.value = selectedNombre + (selectedAlias ? ` (${selectedAlias})` : '');
                                            clienteIdInput.value = selectedId;
                                            clienteSelectedInfo.innerHTML = `<strong>Cliente Seleccionado:</strong> ${selectedNombre} (${selectedTipo.replace('_', ' ').title()})`;
                                            clienteSearchResults.style.display = 'none';

                                            // Cargar direcciones del cliente seleccionado (si aplica)
                                            if (direccionEntregaSelect) {
                                                 loadClienteAddresses(selectedId); // Función para cargar direcciones
                                            }

                                            // Opcional: Actualizar precios en el carrito si ya hay ítems
                                            // updateCartPricesForClient(selectedId);
                                        });
                                        clienteSearchResults.appendChild(div);
                                    });
                                    clienteSearchResults.style.display = 'block';
                                } else {
                                    clienteSearchResults.style.display = 'none';
                                    // Opcional: Mostrar opción para crear nuevo cliente
                                    // showNewClientFields();
                                }
                            })
                            .catch(error => {
                                console.error('Error buscando cliente:', error);
                                clienteSearchResults.style.display = 'none';
                            });
                    }, 300); // Esperar 300ms después de la última tecla
                });

                // Ocultar resultados al hacer clic fuera
                document.addEventListener('click', function(event) {
                    if (!clienteSearchInput.contains(event.target) && !clienteSearchResults.contains(event.target)) {
                        clienteSearchResults.style.display = 'none';
                    }
                });

                // Función para cargar direcciones del cliente (AJAX)
                function loadClienteAddresses(clienteId) {
                    // Limpiar opciones actuales
                    direccionEntregaSelect.innerHTML = '<option value="">Seleccionar Dirección</option>';
                    if (!clienteId) return;

                    fetch("{{ url_for('clientes.get_direcciones_ajax') }}?cliente_id=" + encodeURIComponent(clienteId)) // Usar url_for y pasar el ID del cliente
                        .then(response => response.json())
                        .then(data => {
                            // Read the current pedido's delivery address ID from a data attribute
                            const cardElement = document.querySelector('.card'); // O el elemento que tenga el data attribute
                            const rawPedidoDireccionId = cardElement.dataset.pedidoDireccionId; // Esto será un string ("5" o "null")
                            let currentPedidoDireccionId = null;
                            if (rawPedidoDireccionId && rawPedidoDireccionId !== 'null') {
                                currentPedidoDireccionId = parseInt(rawPedidoDireccionId, 10);
                                if (isNaN(currentPedidoDireccionId)) {
                                    currentPedidoDireccionId = null; // Fallback si el parseo falla
                                }
                            }
                            // Ahora currentPedidoDireccionId es un número entero o null

                            if (data.direcciones && data.direcciones.length > 0) {
                                data.direcciones.forEach(direccion => {
                                    const option = document.createElement('option');
                                    option.value = direccion.id;
                                    option.textContent = `${direccion.calle_numero}, ${direccion.colonia || ''}, ${direccion.ciudad} (${direccion.tipo_direccion.replace('_', ' ').title()})`;
                                    // Seleccionar la dirección actual del pedido si coincide
                                    const currentDireccionId = currentPedidoDireccionId; // Use the variable defined outside the loop
                                    if (currentDireccionId !== null && direccion.id === currentDireccionId) {
                                        option.selected = true;
                                    } else if (direccion.es_principal && currentDireccionId === null) {
                                         // Si el pedido no tiene dirección asignada, seleccionar la principal del cliente
                                         option.selected = true;
                                    }
                                    direccionEntregaSelect.appendChild(option);
                                });
                            } else {
                                // Opcional: Mostrar mensaje o botón para añadir dirección
                                const option = document.createElement('option');
                                option.value = "";
                                option.textContent = "No hay direcciones registradas";
                                option.disabled = true;
                                direccionEntregaSelect.appendChild(option);
                            }
                        })
                        .catch(error => {
                            console.error('Error cargando direcciones:', error);
                        });
                }

                // Si el pedido ya tiene cliente, cargar sus direcciones al cargar la página
                const initialClienteId = clienteIdInput.value;
                if (initialClienteId) {
                     loadClienteAddresses(initialClienteId);
                }
            }


            // --- Lógica para mostrar/ocultar campos de pago ---
            if (formaPagoSelect && efectivoFields) {
                formaPagoSelect.addEventListener('change', function() {
                    // Comparar con el valor string del Enum
                    if (this.value === 'EFECTIVO' || this.value === 'EFECTIVO_CONTRA_ENTREGA') {
                        efectivoFields.style.display = 'block';
                        // Opcional: Enfocar el campo "Paga con"
                        // pagaConInput.focus();
                    } else {
                        efectivoFields.style.display = 'none';
                        // Limpiar campos de efectivo si se ocultan
                        if (pagaConInput) pagaConInput.value = '';
                        if (cambioEntregadoDisplay) cambioEntregadoDisplay.textContent = formatCurrencyJS(0); // Usar helper JS
                    }
                });

                // Disparar el evento change al cargar la página para el valor inicial
                formaPagoSelect.dispatchEvent(new Event('change'));
            }

            // --- Lógica para calcular cambio (solo UI, no guarda en BD aquí) ---
            if (pagaConInput && totalPedidoDisplay && cambioEntregadoDisplay) {
                function calcularCambio() {
                    // Asegurarse de que totalPedidoDisplay contiene solo el número
                    const totalPedidoText = totalPedidoDisplay.textContent.replace('$', '').replace(/,/g, '');
                    const totalPedido = parseFloat(totalPedidoText) || 0;
                    const pagaCon = parseFloat(pagaConInput.value) || 0;
                    const cambio = pagaCon - totalPedido;
                    cambioEntregadoDisplay.textContent = formatCurrencyJS(cambio); // Usar helper JS
                    // Opcional: Mostrar sugerencia de denominaciones (requiere JS avanzado y datos de caja)
                }

                pagaConInput.addEventListener('input', calcularCambio);

                // Calcular cambio inicial si ya hay valores
                calcularCambio();
            }

            // --- Lógica para añadir/editar/eliminar ítems y PAs (Requiere JS/AJAX) ---
            // Implementar funciones addItemToCart, addPaToCart, updateCartDisplay,
            // removeItemFromCart, editItemInCart, removePaFromCart, editPaInCart
            // y asociarlas a los botones correspondientes.

            // Ejemplo de listeners para botones de eliminar (requiere implementar removeItemFromCart y removePaFromCart)
            document.querySelectorAll('.delete-item-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.dataset.itemId;
                    if (confirm('¿Estás seguro de eliminar este ítem?')) {
                        // Lógica AJAX para DELETE /pedidos/{{ pedido.id }}/items/<itemId>
                        console.log("Eliminar ítem:", itemId); // Placeholder
                        // Luego, actualizar la UI (remover el <li>, actualizar totales)
                    }
                });
            });

            document.querySelectorAll('.delete-pa-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const paId = this.dataset.paId;
                    if (confirm('¿Estás seguro de eliminar este producto adicional?')) {
                         // Lógica AJAX para DELETE /pedidos/{{ pedido.id }}/pas/<paId>
                         console.log("Eliminar PA:", paId); // Placeholder
                         // Luego, actualizar la UI (remover el <li>, actualizar totales)
                    }
                });
            });

            // Los botones de editar requerirían abrir un modal o mostrar un formulario
            // con los datos del ítem/PA precargados, y luego enviar la actualización via AJAX.
            // document.querySelectorAll('.edit-item-btn').forEach(button => { ... });
            // document.querySelectorAll('.edit-pa-btn').forEach(button => { ... });


            // El botón "Añadir al Pedido" (new-item-form) y "Añadir PA al Pedido" (new-pa-form)
            // también necesitan event listeners para enviar los datos via AJAX POST
            // a las rutas /pedidos/<pedido_id>/items/nuevo y /pedidos/<pedido_id>/pas/nuevo.

            // Ejemplo de listener para añadir ítem (requiere implementar addItemToCart)
            const addItemBtn = document.getElementById('add-item-btn');
            if (addItemBtn) {
                addItemBtn.addEventListener('click', function() {
                    const form = document.getElementById('new-item-form');
                    const formData = new FormData(form);
                    const itemData = Object.fromEntries(formData.entries());
                    // Convertir cantidades y precios a números si es necesario
                    itemData.cantidad = parseFloat(itemData.cantidad);
                    // itemData.precio_unitario_venta = parseFloat(itemData.precio_unitario_venta); // Si se permite editar
                    // Validar datos antes de enviar
                    if (!itemData.producto_id && !itemData.subproducto_id) {
                        alert("Debe seleccionar un producto o subproducto.");
                        return;
                    }
                    // Lógica AJAX para POST /pedidos/{{ pedido.id }}/items/nuevo
                    console.log("Añadir ítem:", itemData); // Placeholder
                    // Luego, actualizar la UI (añadir nuevo <li>, actualizar totales)
                });
            }

            // Similar para añadir PA (requiere implementar addPaToCart)
            const addPaBtn = document.getElementById('add-pa-btn');
            if (addPaBtn) {
                addPaBtn.addEventListener('click', function() {
                    const form = document.getElementById('new-pa-form');
                    const formData = new FormData(form);
                    const paData = Object.fromEntries(formData.entries());
                    // Convertir cantidades y precios a números si es necesario
                    paData.cantidad_pa = parseFloat(paData.cantidad_pa);
                    paData.precio_venta_unitario_pa = parseFloat(paData.precio_venta_unitario_pa);
                    // Validar datos
                    if (!paData.nombre_pa || isNaN(paData.cantidad_pa) || isNaN(paData.precio_venta_unitario_pa)) {
                         alert("Nombre, cantidad y precio del PA son requeridos y deben ser números válidos.");
                         return;
                    }
                    // Lógica AJAX para POST /pedidos/{{ pedido.id }}/pas/nuevo
                    console.log("Añadir PA:", paData); // Placeholder
                    // Luego, actualizar la UI (añadir nuevo <li>, actualizar totales)
                });
            }

            // Nota: La implementación completa de la gestión del carrito con AJAX
            // es compleja y requeriría funciones adicionales en routes.py y services.py
            // para manejar la actualización del pedido en BD de forma incremental.
            // Las plantillas están diseñadas para soportar la actualización dinámica.

        });
    </script>
{% endblock %}
{% endblock %